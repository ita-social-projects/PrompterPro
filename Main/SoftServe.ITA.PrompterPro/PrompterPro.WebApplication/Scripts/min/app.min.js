var app=angular.module("app",["ngRoute","ui.bootstrap","ngAnimate","truncate","angular-md5"]);$.connection.hub.start(),function(){var e=function(){var e=new Date,t=e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()+" "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds();return t},t=function(t){$.ajax({type:"POST",url:"/api/diagnostics",contentType:"application/json; charset=UTF-8",data:angular.toJson({ExceptionName:t.name||t,Message:t.stack||"",Date:e()})})};window.onerror=function(e){t(e)}}(),function(e,t,n){t.module("angular-md5",["gdi2290.md5"]),t.module("ngMd5",["gdi2290.md5"]),t.module("gdi2290.md5",["gdi2290.gravatar-filter","gdi2290.md5-service","gdi2290.md5-filter"]),t.module("gdi2290.gravatar-filter",[]).filter("gravatar",["md5",function(e){var t={};return function(n,r){return t[n]||(r=r?e.createHash(r.toString().toLowerCase()):"",t[n]=n?e.createHash(n.toString().toLowerCase()):r),t[n]}}]),t.module("gdi2290.md5-filter",[]).filter("md5",["md5",function(e){return function(t){return t?e.createHash(t.toString().toLowerCase()):t}}]),t.module("gdi2290.md5-service",[]).factory("md5",[function(){var e={createHash:function(e){var t,n,r,o,i,a,s,c,d,u,l=function(e,t){return e<<t|e>>>32-t},p=function(e,t){var n,r,o,i,a;return o=2147483648&e,i=2147483648&t,n=1073741824&e,r=1073741824&t,a=(1073741823&e)+(1073741823&t),n&r?2147483648^a^o^i:n|r?1073741824&a?3221225472^a^o^i:1073741824^a^o^i:a^o^i},f=function(e,t,n){return e&t|~e&n},g=function(e,t,n){return e&n|t&~n},m=function(e,t,n){return e^t^n},v=function(e,t,n){return t^(e|~n)},h=function(e,t,n,r,o,i,a){return e=p(e,p(p(f(t,n,r),o),a)),p(l(e,i),t)},S=function(e,t,n,r,o,i,a){return e=p(e,p(p(g(t,n,r),o),a)),p(l(e,i),t)},y=function(e,t,n,r,o,i,a){return e=p(e,p(p(m(t,n,r),o),a)),p(l(e,i),t)},w=function(e,t,n,r,o,i,a){return e=p(e,p(p(v(t,n,r),o),a)),p(l(e,i),t)},P=function(e){for(var t,n=e.length,r=n+8,o=(r-r%64)/64,i=16*(o+1),a=new Array(i-1),s=0,c=0;n>c;)t=(c-c%4)/4,s=c%4*8,a[t]=a[t]|e.charCodeAt(c)<<s,c++;return t=(c-c%4)/4,s=c%4*8,a[t]=a[t]|128<<s,a[i-2]=n<<3,a[i-1]=n>>>29,a},A=function(e){var t,n,r="",o="";for(n=0;3>=n;n++)t=e>>>8*n&255,o="0"+t.toString(16),r+=o.substr(o.length-2,2);return r},D=[],b=7,T=12,C=17,E=22,$=5,I=9,L=14,x=20,O=4,U=11,k=16,R=23,N=6,M=10,z=15,F=21;for(D=P(e),s=1732584193,c=4023233417,d=2562383102,u=271733878,t=D.length,n=0;t>n;n+=16)r=s,o=c,i=d,a=u,s=h(s,c,d,u,D[n+0],b,3614090360),u=h(u,s,c,d,D[n+1],T,3905402710),d=h(d,u,s,c,D[n+2],C,606105819),c=h(c,d,u,s,D[n+3],E,3250441966),s=h(s,c,d,u,D[n+4],b,4118548399),u=h(u,s,c,d,D[n+5],T,1200080426),d=h(d,u,s,c,D[n+6],C,2821735955),c=h(c,d,u,s,D[n+7],E,4249261313),s=h(s,c,d,u,D[n+8],b,1770035416),u=h(u,s,c,d,D[n+9],T,2336552879),d=h(d,u,s,c,D[n+10],C,4294925233),c=h(c,d,u,s,D[n+11],E,2304563134),s=h(s,c,d,u,D[n+12],b,1804603682),u=h(u,s,c,d,D[n+13],T,4254626195),d=h(d,u,s,c,D[n+14],C,2792965006),c=h(c,d,u,s,D[n+15],E,1236535329),s=S(s,c,d,u,D[n+1],$,4129170786),u=S(u,s,c,d,D[n+6],I,3225465664),d=S(d,u,s,c,D[n+11],L,643717713),c=S(c,d,u,s,D[n+0],x,3921069994),s=S(s,c,d,u,D[n+5],$,3593408605),u=S(u,s,c,d,D[n+10],I,38016083),d=S(d,u,s,c,D[n+15],L,3634488961),c=S(c,d,u,s,D[n+4],x,3889429448),s=S(s,c,d,u,D[n+9],$,568446438),u=S(u,s,c,d,D[n+14],I,3275163606),d=S(d,u,s,c,D[n+3],L,4107603335),c=S(c,d,u,s,D[n+8],x,1163531501),s=S(s,c,d,u,D[n+13],$,2850285829),u=S(u,s,c,d,D[n+2],I,4243563512),d=S(d,u,s,c,D[n+7],L,1735328473),c=S(c,d,u,s,D[n+12],x,2368359562),s=y(s,c,d,u,D[n+5],O,4294588738),u=y(u,s,c,d,D[n+8],U,2272392833),d=y(d,u,s,c,D[n+11],k,1839030562),c=y(c,d,u,s,D[n+14],R,4259657740),s=y(s,c,d,u,D[n+1],O,2763975236),u=y(u,s,c,d,D[n+4],U,1272893353),d=y(d,u,s,c,D[n+7],k,4139469664),c=y(c,d,u,s,D[n+10],R,3200236656),s=y(s,c,d,u,D[n+13],O,681279174),u=y(u,s,c,d,D[n+0],U,3936430074),d=y(d,u,s,c,D[n+3],k,3572445317),c=y(c,d,u,s,D[n+6],R,76029189),s=y(s,c,d,u,D[n+9],O,3654602809),u=y(u,s,c,d,D[n+12],U,3873151461),d=y(d,u,s,c,D[n+15],k,530742520),c=y(c,d,u,s,D[n+2],R,3299628645),s=w(s,c,d,u,D[n+0],N,4096336452),u=w(u,s,c,d,D[n+7],M,1126891415),d=w(d,u,s,c,D[n+14],z,2878612391),c=w(c,d,u,s,D[n+5],F,4237533241),s=w(s,c,d,u,D[n+12],N,1700485571),u=w(u,s,c,d,D[n+3],M,2399980690),d=w(d,u,s,c,D[n+10],z,4293915773),c=w(c,d,u,s,D[n+1],F,2240044497),s=w(s,c,d,u,D[n+8],N,1873313359),u=w(u,s,c,d,D[n+15],M,4264355552),d=w(d,u,s,c,D[n+6],z,2734768916),c=w(c,d,u,s,D[n+13],F,1309151649),s=w(s,c,d,u,D[n+4],N,4149444226),u=w(u,s,c,d,D[n+11],M,3174756917),d=w(d,u,s,c,D[n+2],z,718787259),c=w(c,d,u,s,D[n+9],F,3951481745),s=p(s,r),c=p(c,o),d=p(d,i),u=p(u,a);var B=A(s)+A(c)+A(d)+A(u);return B.toLowerCase()}};return e}])}(this,this.angular,void 0),app.factory("constants",function(){return Object.freeze({tagScript:"<Script>",tagSection:"<Section>",tagDescription:"<Description>",SECTION_SPLITTER:"\n\n",scriptDefaultName:"Script",imported:"Successfully imported: ",invalidFormat:"This file format is not supported.",unimported:"Errors occured while importing. Please try again later.",emptyString:"",noPendingChanges:"No pending changes",successfulChanges:" change(s) saved!",changesSaved:"Changes successfully saved",cnagesUnsaved:"Errors occured while saving changes. Please try again later.",changesSavig:"Saving changes...",connectSucces:"Successfully connected with all prompters.",cantConnect:"Errors occured while connecting with prompters. Please try again later.",connectedToOperator:"Successfully connected to operator. Waiting for others to connect.",allConnected:"All prompters successfully connected. Broadcast started.",broadcastEnd:"Broadcast session was ended by operator.",operatorDisconnected:"Broadcast failed. Operator disconnected.",lostConnectionWith:"Lost connection with ",allDisconnected:"All prompters disconnected. Session ended.",broadcastTimeout:6e4,sectionsIntroLength:25,defaultFontSize:10,defaultReadingSpeed:10,defaultAnnouncer:"Default",diagnositcsMessageDisplayLength:100,usrerWithSameName:"User with that name already exists",cantDeleteAdmin:"You cant delete Admin"})}),app.factory("icons",function(){return Object.freeze({ok:"glyphicon glyphicon-ok",info:"glyphicon glyphicon-info-sign",warning:"glyphicon glyphicon-warning-sign"})}),app.factory("webApi",function(){return Object.freeze({presentation:"/api/presentation",script:"/api/script",prompter:"/api/prompter",diagnostics:"/api/diagnostics",userActivity:"/api/userActivity",userActivityActivator:"/api/userActivityActivator"})}),app.controller("prompterController",["$scope","prompterService",function(e,t){$("div.container.body-content").removeClass("container body-content").addClass("container-full");var n="rgb(0, 0, 0)";$("body").css("background-color",n).keyup(function(e){var t=e.keyCode?e.keyCode:e.which;122===t&&$("div.navbar.navbar-inverseNew.navbar-fixed-top").toggleClass("ng-hide")}),e.service=t(e)}]),app.factory("prompterRepository",["$http",function(e){var t={};return t.get=function(t,n){var r="api/script/"+String(t);e.get(r).success(function(e){n(e)})},t}]),app.service("prompterService",["broadcastHub","prompterRepository","constants","notify","notifyType","icons","prompterResolution",function(e,t,n,r,o,i,a){return function(s){function c(){s.isMirroredX=void 0,s.isMorroredY=void 0,s.speed=1,s.leftPadding=0,s.rightPadding=0,s.textSize=90,e.client.stop()}var d,u=$("#area"),l=10,p=1,f=15,g=1;s.textIsChanged=!1,s.textSizes=[50,55,60,70,80,90,100,110,130],s.showDialog=!1,s.speed=1,s.currentSize=s.textSizes[2],s.textSize=90,s.leftPadding=0,s.rightPadding=0,s.hub=e,e.client.fetchScript=function(a,c){t.get(a,function(t){s.script=t,e.server.fetchSuccess(c),r(o.success,n.connectedToOperator,i.ok),s.$apply()})},e.client.operatorConnected=function(){r(o.success,n.allConnected,i.ok),s.$apply()},e.client.broadcastEnd=function(){r(o.success,n.broadcastEnd,i.warning),s.script=null,c(),s.$apply()},e.client.operatorDisconnected=function(){r(o.danger,n.operatorDisconnected,i.warning),s.script=null,c(),s.$apply()},e.client.play=function(){d=setInterval(function(){u.scrollTop()<=u.get(0).scrollHeight&&u.scrollTop(u.scrollTop()+s.speed)},f)},e.client.pause=function(){clearInterval(d)},e.client.stop=function(){clearInterval(d),u.scrollTop(0)},e.client.changeTextSize=function(e){s.textSize=e,s.$apply()},e.client.speedUp=function(){s.speed<l&&s.speed++},e.client.speedDown=function(){s.speed>p&&s.speed--},e.client.mirrorText=function(e,t){e&&t&&u.css({transform:"matrix(-1, 0, 0, -1, 0, 0)"}),e&&!t&&u.css({transform:"matrix(-1, 0, 0, 1, 0, 0)"}),!e&&t&&u.css({transform:"matrix(1, 0, 0, -1, 0, 0)"}),e||t||u.css({transform:"matrix(1, 0, 0, 1, 0, 0)"})},e.client.handPlayBack=function(){e.client.pause(),d=setInterval(function(){u.scrollTop()>0&&u.scrollTop(u.scrollTop()-s.speed)},f)},e.client.handPlay=function(){e.client.pause(),d=setInterval(function(){u.scrollTop()<=u.get(0).scrollHeight&&u.scrollTop(u.scrollTop()+s.speed)},f)},e.client.clearText=function(){document.getElementById("area").value=""},s.displayText=function(){var e="\n\n",t=s.script.Sections;return _.each(t,function(t){e+="[Section:"+t.Order+"]\n"+t.Text+"\n"}),e},e.client.padLeft=function(e){s.leftPadding=e,s.$apply()},e.client.padRight=function(e){s.rightPadding=e,s.$apply()},e.client.setResolution=function(t){t==a.Small&&(document.getElementById("area").width=600,g=1,e.client.changeTextSize(s.currentSize*g)),t==a.Medium&&(document.getElementById("area").width=800,g=1.5,e.client.changeTextSize(s.currentSize*g)),t==a.Large&&(document.getElementById("area").width=1200,g=2,e.client.changeTextSize(s.currentSize*g))};var m={};return m}}]),app.directive("switch",function(){return{restrict:"AE",replace:!0,transclude:!0,template:function(e,t){var n="";return n+="<span",n+=' class="switch'+(t["class"]?" "+t["class"]:"")+'"',n+=t.ngModel?' ng-click="'+t.ngModel+"=!"+t.ngModel+(t.ngChange?"; "+t.ngChange+'()"':'"'):"",n+=' ng-class="{ checked:'+t.ngModel+' }"',n+=">",n+="<small></small>",n+='<input type="checkbox"',n+=t.id?' id="'+t.id+'"':"",n+=t.name?' name="'+t.name+'"':"",n+=t.ngModel?' ng-model="'+t.ngModel+'"':"",n+=' style="display:none" />',n+="</span>"}}}),app.controller("adminController",["$scope",function(e){e.isUsersTabActive=!1,e.isDiagnosticsTabActive=!1,e.isHistoryTabActive=!1,e.makeUserTab=function(){e.isUsersTabActive=!0,e.isDiagnosticsTabActive=!1,e.isHistoryTabActive=!1},e.makeDiagnosticsTab=function(){e.isUsersTabActive=!1,e.isDiagnosticsTabActive=!0,e.isHistoryTabActive=!1},e.makeHistoryTab=function(){e.isUsersTabActive=!1,e.isDiagnosticsTabActive=!1,e.isHistoryTabActive=!0},e.autoClick=function(e){var t=document.getElementById(e.toString());t.click()}}]),app.controller("datepickerController",["$scope","diagnosticsService","dateFormater",function(e,t,n){e.lastPeriod=function(){e.dt=(new Date).setDate((new Date).getDate()-7)},e.lastPeriod(),e.clear=function(){e.dt=null},e.today=new Date,e.$watch(function(){return e.dt},function(r){if(r){var o=new Date(r),i=o.getFullYear()+"-"+(o.getMonth()+1)+"-"+o.getDate();t.getFromDate(i).then(function(t){e.$parent.diagnostics=t,_.each(t,function(e){e.Date=n.formateDate(e.Date)})})}}),e.open=function(t){t.preventDefault(),t.stopPropagation(),e.opened=!0},e.dateOptions={startingDay:1},e.format="yyyy-MM-dd"}]),app.controller("diagnosticsController",["$scope","diagnosticsService","dateFormater","$modal","constants",function(e,t,n,r,o){t.getLastDiagnostics().then(function(t){e.diagnostics=t,_.each(t,function(e){e.Date=n.formateDate(e.Date)})}),e.messageDisplayLength=o.diagnositcsMessageDisplayLength,e.openMessageModal=function(e){if(e.Message.length>o.diagnositcsMessageDisplayLength){r.open({templateUrl:"fullMessageModal.html",controller:"diagnosticsMessageModalController",resolve:{diagnostic:function(){return e}}})}}}]),app.controller("diagnosticsMessageModalController",["$scope","$modalInstance","diagnostic",function(e,t,n){e.name=n.ExceptionName,e.message=n.Message,e.close=function(){t.dismiss("close")}}]),app.controller("modalEditInstanceController",["$scope","$modalInstance","userForEditing",function(e,t,n){e.userForEditing=n,e.ok=function(){t.close(e.userForEditing)},e.cancel=function(){t.close(e.copy)}}]),app.controller("modalAddInstanceController",["$scope","$modalInstance","newUser",function(e,t,n){e.newUser=n,e.ok=function(){t.close(e.newUser)},e.cancel=function(){t.dismiss("cancel")}}]),app.controller("userActivityController",["$scope","userActivityService","userActivityRepository","userActivityCachingService",function(e,t,n,r){e.activityStatus=!1,e.isLoadingInProcess=!0,e.logPage=1,e.logsPerPage=50,e.isActivityStateChanging=!0,e.cachedLogs=new Array,e.currentPageLogs=void 0,e.dateFormatter=t.dateFormatter,e.formatUserActivityStatus=t.getUserActivityStatus,e.errorNotification=t.errorNotification,e.handleNewLogs=t.handleNewLogs,e.addPageToCache=r.addPageToCache,e.isPageCached=r.isPageCached,e.getPageFromCache=r.getPageFromCache,e.refreshCachePage=r.refreshCachePage,r.clearCache(),e.openConfirmationWindow=function(){$("#confirmationModal").modal("show")},e.closeConfirmationWindow=function(){$("#confirmationModal").modal("hide")},e.isAnyLogAvaible=function(){return 0===e.currentPageLogs.length},e.clearAllUserActivityHistory=function(){n.userActivity.clearAllHistory().then(function(){e.cachedLogs=new Array,e.refreshCurrentPage(),e.isAnyLogAvaible=e.disableNextPageButton()},function(){e.errorNotification("failed to clear user activity history.")}),e.closeConfirmationWindow()},e.acceptActivityStatus=function(t){e.activityStatus=t,e.isActivityStateChanging=!1},e.disablePreviousPageButton=function(){return 1===e.logPage},e.disableNextPageButton=function(){return void 0!==e.currentPageLogs?e.currentPageLogs.length%e.logsPerPage!==0||0===e.currentPageLogs.length:!1},e.refreshCurrentPage=function(){e.isLoadingInProcess=!0,n.userActivity.get(e.logPage).then(function(t){e.currentPageLogs=e.handleNewLogs(t),e.refreshCachePage(e.currentPageLogs,e.logPage),e.isLoadingInProcess=!1},function(){e.errorNotification("failed to refresh current page."),e.isLoadingInProcess=!1})},e.acceptNewLogs=function(t){e.currentPageLogs=e.handleNewLogs(t),e.addPageToCache(e.currentPageLogs),e.isLoadingInProcess=!1},n.userActivity.get(1).then(e.acceptNewLogs,function(){e.errorNotification("failed to load user activity logs"),e.isLoadingInProcess=!1}),n.userActivityActivator.get().then(e.acceptActivityStatus,function(){e.errorNotification("failed to load user activity logging state."),e.isActivityStateChanging=!1}),e.changeTrackingState=function(){e.isActivityStateChanging=!0,n.userActivityActivator.post(!e.activityStatus).then(e.acceptActivityStatus,function(){e.errorNotification("failed to change user activity logging state."),e.isActivityStateChanging=!1})},e.getNextPage=function(){return e.logPage++,e.isPageCached(e.logPage)?void(e.currentPageLogs=e.getPageFromCache(e.logPage)):(e.isLoadingInProcess=!0,void n.userActivity.get(e.logPage).then(e.acceptNewLogs,function(){e.errorNotification("failed to get next page."),e.currentPageLogs=[],e.isLoadingInProcess=!1}))},e.getPreviousPage=function(){return e.logPage--,e.isPageCached(e.logPage)?void(e.currentPageLogs=e.getPageFromCache(e.logPage)):(e.isLoadingInProcess=!0,void n.userActivity.get(e.logPage).then(e.acceptNewLogs,function(){e.errorNotification("failed to load previous page."),e.currentPageLogs=[],e.isLoadingInProcess=!1}))}}]),app.controller("usersController",["$scope","$modal","$log","userRepository","serverService","dialogSevice","entityState","role","manageListOfUsers","manageUserSate","notify","notifyType","icons","constants","userStateControll","validationService",function(e,t,n,r,o,i,a,s,c,d,u,l,p,f,g,m){e.showOkRemove=!1,e.showEditDelete=!0,e.showOddAndEven=!0,e.showPrompterStatus=!1,e.isEdited=!1,e.isDeleted=!1,e.managedUserslist=new Array,e.setIsDeleted=function(){e.isDeleted=!0},e.setIsEdited=function(t){e.isEdited=t},e.setShowOddAndEven=function(t){e.showOddAndEven=t},e.setShowPrompterStatus=function(t){e.showPrompterStatus=t},e.setShowEditDelete=function(t){e.showEditDelete=t},e.setShowOkRemove=function(t){e.showOkRemove=t},e.showPromStatus=function(t){e.showPrompterStatus=t===s.Prompter.Name?!0:!1},e.setUpdatedState=function(e){d.setModifiedState(e)},e.setDeletedState=function(e){d.setDeletedState(e)},e.setAddedState=function(t){e.users.push(t),d.setAddedState(t)},e.deleteCurrentUser=function(t){m.checkIfAdmin(t)?u(l.danger,f.cantDeleteAdmin,p.warning):-1!==e.managedUserslist.indexOf(t)&&e.managedUserslist[e.managedUserslist.indexOf(t)].EntityState===a.Added?(e.removeFromList(t),e.removeFromList(t)):(e.setDeletedState(t),e.addMangedUserToList(t))},e.openEditDialog=function(t,n){i.openEditDialog(t,n,e)},e.openAddDialog=function(t){i.openAddDialog(t,e)},e.addMangedUserToList=function(t){c.addToList(e,t)},e.removeFromList=function(t){c.removeFromList(e,t)},e.getUserForEditing=function(t){e.userForEditing=t},e.fetchUsers=function(){o.readAllUsers(e)},e.controlUserColor=g(e),e.saveAllChanges=function(){e.managedUserslist.length>0?(o.manageUser(e,e.managedUserslist),u(l.success,e.managedUserslist.length+f.successfulChanges,p.success)):u(l.danger,f.noPendingChanges,p.warning)}}]),app.service("diagnosticsService",["$http","$q",function(e,t){return{getLastDiagnostics:function(){var n=t.defer();return e.get("/api/diagnostics").success(function(e){n.resolve(e)}).error(function(e){n.reject(e)}),n.promise},getFromDate:function(n){var r=t.defer();return n&&(n="?fromDate="+n,e.get("/api/diagnostics"+n).success(function(e){r.resolve(e)}).error(function(e){r.reject(e)})),r.promise}}}]),app.factory("dialogSevice",["$modal","role","prompterStatus","validationService","notify","notifyType","icons","constants","md5",function(e,t,n,r,o,i,a,s,c){return{openAddDialog:function(d,u){u.newUser={EntitySate:null,Login:null,Password:null,Disabled:!1,PrompterStatus:null,Role:{EntityState:2,Name:null,RoleId:null},RoleId:null};var l=e.open({templateUrl:"addUserModal.html",controller:"modalAddInstanceController",size:d,resolve:{newUser:function(){return u.newUser}}});l.result.then(function(e){l.result.$$state.value&&(r.checkUserExisting(u.users,e.Login)?(e.Role.Name===t.Admin.Name&&(e.RoleId=t.Admin.RoleId,e.Role.RoleId=t.Admin.RoleId),e.Role.Name===t.Operator.Name&&(e.RoleId=t.Operator.RoleId,e.Role.RoleId=t.Operator.RoleId),e.Role.Name===t.Prompter.Name&&(e.RoleId=t.Prompter.RoleId,e.Role.RoleId=t.Prompter.RoleId,e.PrompterStatus=n.Off),e.Password=c.createHash(e.Password||""),u.setAddedState(e),u.addMangedUserToList(e)):o(i.danger,s.usrerWithSameName,a.warning))})},openEditDialog:function(t,n,o){var i=angular.copy(n),a=e.open({templateUrl:"editUserModal.html",controller:"modalEditInstanceController",size:t,resolve:{userForEditing:function(){return i}}});a.result.then(function(e){if(a.result.$$state.value){var t=o.users.indexOf(n);r.checkUsersRole(o.users[t],e),o.users[t]=e,o.setUpdatedState(e),o.addMangedUserToList(e)}})}}}]),app.factory("manageUserSate",["entityState",function(e){return{setAddedState:function(t){t.EntityState=e.Added},setDeletedState:function(t){t.EntityState=e.Modified,t.Disabled=!0},setModifiedState:function(t){t.EntityState=e.Modified}}}]),app.factory("manageListOfUsers",[function(){return{addToList:function(e,t){e.managedUserslist.push(t)},removeFromList:function(e,t){e.users.splice(e.users.indexOf(t),1)}}}]),app.config(["$routeProvider","$locationProvider",function(e,t){e.when("/Admin/Users",{templateUrl:"/Admin/Users",controller:"usersController"}).when("/Admin/Diagnostics",{templateUrl:"/Admin/Diagnostics",controller:"diagnosticsController"}).when("/Admin/UserActivity",{templateUrl:"/Admin/UserActivity",controller:"userActivityController"}),t.html5Mode(!1).hashPrefix("!")}]),app.factory("serverService",["userRepository",function(e){return{readAllUsers:function(t){e.get().then(function(e){t.users=e})},getUserByLogin:function(t,n){e.getByLogin(n).then(function(e){t.result=e})},manageUser:function(t,n){e.post(n).then(function(e){t.users=e,t.managedUserslist.length=0})}}}]),app.service("userStateControll",["entityState",function(e){return function(t){return function(t){return t.Disabled===!0?"danger":t.EntityState===e.Modified?"warning":t.EntityState===e.Added?"success":null}}}]),app.factory("validationService",["entityState","role",function(e,t){return{checkUserExisting:function(e,t){for(var n=e.length,r=0;n>r;r++)if(e[r].Login===t)return!1;return!0},checkUsersRole:function(e,n){e.Role.Name!==n.Role.Name&&(t.Admin.Name===n.Role.Name&&(n.Role=t.Admin,n.RoleId=t.Admin.RoleId,n.PrompterStatus=null),t.Operator.Name===n.Role.Name&&(n.Role=t.Operator,n.RoleId=t.Operator.RoleId,n.PrompterStatus=null),t.Prompter.Name===n.Role.Name&&(n.Role=t.Prompter,n.RoleId=t.Prompter.RoleId,n.PrompterStatus="Off"))},checkIfAdmin:function(e){return"Admin"===e.Login&&"Admin"===e.Role.Name?!0:!1}}}]),app.controller("loginController",["$scope","$window","broadcastHub","$location",function(e,t,n,r){e.refresh=function(){n.server.logOff(),t.location.href="/Login/Logout"}}]),app.controller("user-controller",["$scope","loginService","$window","md5",function(e,t,n,r){e.IsLogedIn=!1,e.Submitted=!1,e.IsFormValid=!1,e.Pass="",e.LoginData={Login:"",Password:""},e.$watch("loginform.$valid",function(t){e.IsFormValid=t}),e.sendLoginToServer=function(){e.ModelError="",e.Submitted=!0,e.IsFormValid&&(e.LoginData.Password=r.createHash(e.Pass||""),t.getUser(e.LoginData).then(function(t){null!=t.data.Login?(e.IsLogedIn=!0,n.location.href=t.data.Role.Name):e.ModelError="Login / Password is incorrect"}))}}]),app.directive("autoSize",["$timeout","entityState",function(e,t){var n=77,r=300,o=0,i=function(e){e.css("background","#fcf8e3"),e.css("color","#8a6d3b")},a=function(e){e.css("background","#dff0d8"),e.css("color","#3c763d")},s=function(e){e.css("overflow","auto"),e.css("height",r+"px")},c=function(e,t,r){e.section.Text.length<r&&t.css("height","auto"),o=t[0].scrollHeight,o>n&&(t.css("height",o+"px"),t.css("overflow","hidden"))};return{restrict:"A",link:function(n,o,d){o.css("resize","none");var u=n.section.Text.length,l=function(){n.section.EntityState===t.Modified&&i(o),n.section.EntityState===t.Added&&a(o),o[0].scrollHeight<r?(c(n,o,u),u=n.section.Text.length):s(o)};n.$watch(d.ngModel,function(){l()}),d.$set("ngTrim","false"),e(l,0)}}}]),app.directive("fileModel",["$parse",function(e){return{restrict:"A",link:function(t,n,r){var o=e(r.fileModel),i=o.assign;n.bind("change",function(){t.$apply(function(){i(t,n[0].files[0])})})}}}]),app.directive("modalModel",function(){return{restrict:"A",link:function(e,t,n){e.$watch(n.visible,function(e){$(t).modal(1==e?"show":"hide")}),$(t).on("shown.bs.modal",function(){e.$apply(function(){e[n.visible]=!0})}),$(t).on("hidden.bs.modal",function(){e.$apply(function(){e[n.visible]=!1})})}}}),app.factory("entityState",function(){return Object.freeze({Unchanged:2,Added:4,Deleted:8,Modified:16})}),app.factory("listGroupItem",function(){return Object.freeze({danger:"list-group-item-danger",heading:"list-group-item-heading",info:"list-group-item-info",success:"list-group-item-success",text:"list-group-item-text",warning:"list-group-item-warning",none:""})}),app.factory("prompterResolution",function(){return Object.freeze({Small:0,Medium:1,Large:2})}),app.factory("prompterStatus",function(){return Object.freeze({On:"On",Busy:"Busy",Off:"Off",order:Object.freeze({On:1,Busy:2,Off:3})})}),app.factory("role",[function(){return Object.freeze({Admin:Object.freeze({RoleId:1,Name:"Admin"}),Operator:Object.freeze({RoleId:2,Name:"Operator"}),Prompter:Object.freeze({RoleId:3,Name:"Prompter"})})}]),app.factory("textSizes",function(){return Object.freeze({15:15,20:20,25:25,30:30,35:35,40:40})}),app.service("notify",function(){return function(e,t,n){$.notify({message:t,icon:n},{type:e,placement:{from:"bottom",align:"right"},template:'<div data-notify="container" class="col-xs-11 col-sm-3 alert alert-{0}" role="alert"><button type="button" aria-hidden="true" class="close" data-notify="dismiss">Ã—</button><span data-notify="icon"></span> <span data-notify="message">{2}</span></div>'})}}),app.factory("notifyType",function(){return Object.freeze({success:"success",info:"info",warning:"warning",danger:"danger"})}),app.factory("broadcastHub",function(){$.connection.hub.start();var e=$.connection.broadcastHub;return e}),app.service("dateFormater",[function(){var e=this;return e.formateDate=function(e){var t=e.substr(0,4),n=e.substr(5,2),r=e.substr(8,2),o=e.substr(11,2),i=e.substr(14,2),a=e.substr(17,2),s=r+"/"+n+"/"+t+" - "+o+":"+i+":"+a;return s},e}]),app.service("fileUpload",["$http",function(e){return function(t,n,r,o){var i=new FormData;i.append("file",t),e.post(n,i,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(e){r&&r(e)}).error(function(e){o&&o(e)})}}]),app.factory("loginService",["$http",function(e){var t={};return t.getUser=function(t){return e({url:"/Login/UserLogin",method:"POST",data:JSON.stringify(t),headers:{"content-type":"application/json"}})},t}]),app.factory("userRepository",["$http","$q",function(e,t){return{get:function(){var n=t.defer();return e.get("/api/user/").success(function(e){n.resolve(e)}).error(function(e){alert(e)}),n.promise},getByLogin:function(n){var r=t.defer();return e.get("/api/user/"+n).success(function(e){r.resolve(e)}).error(function(e){alert(e)}),r.promise},post:function(n){var r=t.defer();return e.post("/api/user/",n).success(function(e){r.resolve(e)}).error(function(e){alert(e)}),r.promise}}}]),app.controller("customizePromptersDialog",["$scope","$modalInstance","broadcastOperator","selectedPrompters",function(e,t,n,r){e.items=r,e.ok=function(){t.close(e.items)},e.checkAllX=function(){e.selectedAllX=e.selectedAllX?!0:!1,angular.forEach(e.items,function(t){t.IsMirroredX=e.selectedAllX})},e.checkAllY=function(){e.selectedAllY=e.selectedAllY?!0:!1,angular.forEach(e.items,function(t){t.IsMirroredY=e.selectedAllY})},e.options=[{label:"600x800",value:0},{label:"800x1200",value:1},{label:"1200x1600",value:2}],angular.forEach(e.items,function(t){t.Resolution=e.options[0]}),e.selectedAllResolution=e.options[0],e.checkAllResolution=function(){angular.forEach(e.items,function(t){t.Resolution=e.selectedAllResolution})}}]),app.controller("playerController",["$scope","broadcastHub","broadcastOperator","$modal",function(e,t,n,r){function o(){e.isMirroredX=void 0,e.isMirroredY=void 0,e.speed=1,e.leftPadding=0,e.rightPadding=0,e.textSize=90,e.stop()}e.open=function(t){var n=r.open({templateUrl:"customizePrompter.html",controller:"customizePromptersDialog",size:t,resolve:{selectedPrompters:function(){return e.broadcastOperator.getConnected()}}});n.result.then(function(){e.broadcastOperator.configurePrompters()},function(){e.broadcastOperator.configurePrompters()})};var i,a=$("#area"),s=10,c=1,d=15;e.textIsChanged=!1,e.textSizes=[50,55,60,70,80,90,100,110,130],e.showDialog=!1,e.speed=1,e.currentSize=e.textSizes[6],e.textSize=90,e.isPlayDisabled=!1,e.isNavigateButtonShown=!1,e.leftPadding=0,e.rightPadding=0,e.isMirroredX=void 0,e.isMirroredY=void 0,e.displayText=function(){var t="\n",n=e.$parent.selectedScript.Sections;return _.each(n,function(e){t+="[Section:"+e.Order+"]\n"+e.Text+"\n"}),t},e.mirrorText=function(e,n){t.server.mirrorText(e,n)},e.closePlayer=function(){o(),e.broadcastOperator.successEndBroadcast()},e.dontSaveChanges=function(){e.showDialog=!1,e.textIsChanged=!1,e.broadcastOperator.successEndBroadcast()},e.saveChanges=function(){e.showDialog=!1,e.textIsChanged=!1,e.broadcastOperator.successEndBroadcast()},e.play=function(){e.isPlayDisabled=!0,i=setInterval(function(){a.scrollTop()<=a.get(0).scrollHeight&&a.scrollTop(a.scrollTop()+e.speed)},d),t.server.play()},e.handPlayBack=function(){e.pause(),i=setInterval(function(){a.scrollTop()>0&&a.scrollTop(a.scrollTop()-e.speed)},d),t.server.handPlayBack()},e.handPlay=function(){e.pause(),i=setInterval(function(){a.scrollTop()<=a.get(0).scrollHeight&&a.scrollTop(a.scrollTop()+e.speed)},d),t.server.handPlay()},e.pause=function(){e.isHandPlayDisabled=!1,e.isPlayDisabled=!1,clearInterval(i),t.server.pause()},e.stop=function(){e.isPlayDisabled=!1,e.pause(),a.scrollTop(0),t.server.stop()},e.speedUp=function(){e.speed<s&&e.speed++,t.server.speedUp()},e.speedDown=function(){e.speed>c&&e.speed--,t.server.speedDown()},e.getNextSection=function(){},e.getPrevSection=function(){},e.padRight=function(e){t.server.padRight(e)},e.padLeft=function(e){t.server.padLeft(e)},e.changeTextSize=function(e){t.server.changeTextSize(e)}}]),app.controller("promptersController",["$scope","prompterRepository","prompterClass","prompterOrder","prompterChecked","fetchPrompters",function(e,t,n,r,o,i){e.fetchAllPrompters=i.getPrompters(e,t);var a=$.connection.refreshPrompterHub;a.client.displayStatus=function(){e.fetchAllPrompters=i.getPrompters(e,t)},$.connection.hub.start(),e.prompterOrder=r,e.prompterClass=n,e.prompterChecked=o}]),app.controller("scriptController",["$scope","initScriptCtrlProps","initScriptCtrlFunctions","scriptRepository","broadcastHub",function(e,t,n,r,o){t(e),n(e),r.get().then(function(t){e.scripts=t,e.selectedScript=null})}]),app.directive("dndDraggable",["$parse","$timeout","dndDropEffectWorkaround","dndDragTypeWorkaround",function(e,t,n,r){return function(o,i,a){i.attr("draggable","true"),a.dndDisableIf&&o.$watch(a.dndDisableIf,function(e){i.attr("draggable",!e)}),i.on("dragstart",function(s){s=s.originalEvent||s,s.dataTransfer.setData("Text",angular.toJson(o.$eval(a.dndDraggable))),s.dataTransfer.effectAllowed=a.dndEffectAllowed||"move",i.addClass("dndDragging"),t(function(){i.addClass("dndDraggingSource")},0),n.dropEffect="none",r.isDragging=!0,r.dragType=a.dndType?o.$eval(a.dndType):void 0,e(a.dndDragstart)(o,{event:s}),s.stopPropagation()}),i.on("dragend",function(t){t=t.originalEvent||t;var s=n.dropEffect;o.$apply(function(){switch(s){case"move":e(a.dndMoved)(o,{event:t});break;case"copy":e(a.dndCopied)(o,{event:t})}}),i.removeClass("dndDragging"),i.removeClass("dndDraggingSource"),r.isDragging=!1,t.stopPropagation()}),i.on("click",function(t){t=t.originalEvent||t,o.$apply(function(){e(a.dndSelected)(o,{event:t})}),t.stopPropagation()}),i.on("selectstart",function(){return this.dragDrop&&this.dragDrop(),!1})}}]).directive("dndList",["$parse","$timeout","dndDropEffectWorkaround","dndDragTypeWorkaround",function(e,t,n,r){return function(o,i,a){function s(e,t,n){var r=v?e.offsetX||e.layerX:e.offsetY||e.layerY,o=v?t.offsetWidth:t.offsetHeight,i=v?t.offsetLeft:t.offsetTop;return i=n?i:0,i+o/2>r}function c(){return Array.prototype.indexOf.call(m.children,g)}function d(e){if(!r.isDragging&&!h)return!1;if(!p(e.dataTransfer.types))return!1;if(a.dndAllowedTypes&&r.isDragging){var t=o.$eval(a.dndAllowedTypes);if(angular.isArray(t)&&-1===t.indexOf(r.dragType))return!1}return a.dndDisableIf&&o.$eval(a.dndDisableIf)?!1:!0}function u(){return f.remove(),i.removeClass("dndDragover"),!0}function l(t,n,i){return e(t)(o,{event:n,index:c(),item:i||void 0,external:!r.isDragging,type:r.isDragging?r.dragType:void 0})}function p(e){if(!e)return!0;for(var t=0;t<e.length;t++)if("Text"===e[t]||"text/plain"===e[t])return!0;return!1}var f=angular.element("<div class='dndPlaceholder'></div>"),g=f[0],m=i[0],v=a.dndHorizontalList&&o.$eval(a.dndHorizontalList),h=a.dndExternalSources&&o.$eval(a.dndExternalSources);i.on("dragover",function(e){if(e=e.originalEvent||e,!d(e))return!0;if(g.parentNode!=m&&i.append(f),e.target!==m){for(var t=e.target;t.parentNode!==m&&t.parentNode;)t=t.parentNode;t.parentNode===m&&t!==g&&(s(e,t)?m.insertBefore(g,t):m.insertBefore(g,t.nextSibling))}else if(s(e,g,!0))for(;g.previousElementSibling&&(s(e,g.previousElementSibling,!0)||0===g.previousElementSibling.offsetHeight);)m.insertBefore(g,g.previousElementSibling);else for(;g.nextElementSibling&&!s(e,g.nextElementSibling,!0);)m.insertBefore(g,g.nextElementSibling.nextElementSibling);return a.dndDragover&&!l(a.dndDragover,e)?u():(i.addClass("dndDragover"),e.preventDefault(),e.stopPropagation(),!1)}),i.on("drop",function(e){if(e=e.originalEvent||e,!d(e))return!0;e.preventDefault();var t,r=e.dataTransfer.getData("Text")||e.dataTransfer.getData("text/plain");

try{t=JSON.parse(r)}catch(i){return u()}if(a.dndDrop&&(t=l(a.dndDrop,e,t),!t))return u();var s=o.$eval(a.dndList);return o.$apply(function(){s.splice(c(),0,t)}),n.dropEffect="none"===e.dataTransfer.dropEffect?"copy"===e.dataTransfer.effectAllowed||"move"===e.dataTransfer.effectAllowed?e.dataTransfer.effectAllowed:e.ctrlKey?"copy":"move":e.dataTransfer.dropEffect,u(),e.stopPropagation(),!1}),i.on("dragleave",function(e){e=e.originalEvent||e,i.removeClass("dndDragover"),t(function(){i.hasClass("dndDragover")||f.remove()},100)})}}]).factory("dndDragTypeWorkaround",function(){return{}}).factory("dndDropEffectWorkaround",function(){return{}}),app.directive("setFocus",function(){return{scope:{trigger:"=setFocus"},link:function(e,t){e.$watch("trigger",function(n){n===!0&&(t[0].focus(),e.trigger=!1)})}}}),app.filter("scriptFilter",["entityState",function(e){return function(t){return _.filter(t,function(t){return t.EntityState!=e.Deleted})}}]),app.service("userActivityRepository",["$http","$q","webApi",function(e,t,n){var r=this;return r.userActivity={get:function(r){var o=t.defer();return e.get(n.userActivity+"?page="+r).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},post:function(r){var o=t.defer();return e.post(n.userActivity,{page:r}).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},clearAllHistory:function(){var r=t.defer();return e["delete"](n.userActivity).success(function(e){r.resolve(e)}).error(function(e){r.reject(e)}),r.promise}},r.userActivityActivator={get:function(){var r=t.defer();return e.get(n.userActivityActivator).success(function(e){r.resolve(e)}).error(function(e){r.reject(e)}),r.promise},post:function(r){var o=t.defer();return e.post(n.userActivityActivator+"?isUserActivityActivated="+r).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise}},r}]),app.service("userActivityService",["dateFormater","notify","notifyType","icons",function(e,t,n,r){var o=this;return o.dateFormatter=e.formateDate,o.getUserActivityStatus=function(e){return e?"on":"off"},o.errorNotification=function(e){t(n.danger,e,r.warning)},o.handleNewLogs=function(t){return _.each(t,function(t){t.Date=e.formateDate(t.Date)}),t},o}]),app.service("userActivityCachingService",[function(){var e=this,t=new Array;return e.clearCache=function(){t=new Array},e.addPageToCache=function(e){t.push(e)},e.isPageCached=function(e){var n=e-1;return t.length>n},e.getPageFromCache=function(e){var n=e-1;return t[n]},e.refreshCachePage=function(e,n){var r=n-1;t[r]=e},e}]),app.service("initScriptCtrlFunctions",["scriptService","scriptClass","scriptOrder","canPlay","operatorDialog","manageSections","sectionServices","broadcastOperator",function(e,t,n,r,o,i,a,s){return function(c){c.scriptService=e(c),c.scriptClass=t(c),c.canPlay=r(c),c.scriptOrder=n,c.operatorDialog=o(c),c.broadcastOperator=s(c),c.dragSectionTemplate=[],i.initNewSection(c.dragSectionTemplate),c.displaySectionIntro=a.displaySectionIntro,c.updateSectionState=i.updateSectionState,c.isDeleted=i.isDeleted,c.deleteSection=i.deleteSection,c.moveSection=i.moveSection,c.dragNewSection=i.dragNewSection,c.addNewSection=i.addNewSection}}]),app.service("initScriptCtrlProps",["constants","entityState",function(e,t){return function(n){n.checked=[],n.$watch(function(){return!n.scripts},function(e){n.showLoader=e}),n.$watch(function(){return!(n.showLoader||n.showPlayer)},function(e){n.showWorkspace=e}),n.$watch(function(){return Boolean(n.selectedScript)},function(e){n.showEditor=e}),n.showScriptList=!0,n.scriptListClick=function(){n.showScriptList=!n.showScriptList},n.showPrompterList=!0,n.prompterListClick=function(){n.showPrompterList=!n.showPrompterList},n.newScriptName=e.scriptDefaultName,n.$watch(function(){return n.scripts?_.some(n.scripts,function(e){return e.EntityState!==t.Unchanged}):!1},function(e){n.canSave=e}),n.$watch(function(){return $("#my-script-area").width()},function(e){e&&$("#my-head-bar").width(e)})}}]),app.service("operatorDialog",function(){return function(e){var t={};return t.script=function(){e.showScriptModal=!0},t["import"]=function(){e.showImport=!0},t}}),app.factory("fetchPrompters",["prompterStatus",function(e){return{getPrompters:function(t,n){n.get().then(function(n){t.prompters=n;var r=t.$parent.checked;if(r){var o=[];_.each(r,function(t){var r=_.find(n,function(n){return n.UserId===t.UserId&&n.PrompterStatus===e.On});r&&(r.checked=!0,o.push(r))}),t.$parent.checked=o,t.checked=o}})}}}]),app.service("prompterChecked",[function(){return function(e){return e.checked}}]),app.service("prompterClass",["prompterStatus","listGroupItem",function(e,t){return function(n){return n.PrompterStatus===e.On?t.success:n.PrompterStatus===e.Busy?t.warning:t.none}}]),app.service("prompterOrder",["prompterStatus",function(e){return function(t){return e.order[t.PrompterStatus]}}]),app.factory("prompterRepository",["$http","$q","webApi",function(e,t,n){var r={};return r.get=function(){var r=t.defer();return e.get(n.prompter).success(function(e){r.resolve(e)}).error(function(e){r.reject(e)}),r.promise},r}]),app.service("broadcastOperator",["broadcastHub","constants","notify","notifyType","icons","prompterStatus",function(e,t,n,r,o,i){return function(a){var s,c,d,u,l={};return a.index,l.configurePrompters=function(){var t=[];_.each(d,function(e){t.push({PrompterId:e.UserId,IsMirroredX:e.IsMirroredX|!1,IsMirroredY:e.IsMirroredY|!1,Resolution:0})}),e.server.configurePrompters(t)},l.getConnected=function(){return d},l.startBroadcast=function(){a.showWorkspace=!1,a.connecting=!0,a.sortedScripts=_.sortBy(a.scripts,"Title"),a.index=_.indexOf(a.sortedScripts,a.selectedScript),s=0,c=a.checked,d=[],c.length&&(u={ScriptId:a.sortedScripts[a.index].ScriptId,PrompterIdList:[]},_.each(c,function(e){e.PrompterStatus===i.On&&u.PrompterIdList.push(e.UserId)}),e.server.startBroadcast(u),setTimeout(function(){a.connecting&&e.client.cantStartBroadcast()},t.broadcastTimeout))},l.errorEndBroadcast=function(){u&&(e.server.errorEndBroadcast(),u=null),a.connecting=!1,a.showPlayer=!1,a.showWorkspace=!0},l.successEndBroadcast=function(){u&&(e.server.successEndBroadcast(),u=null),a.connecting=!1,a.showPlayer=!1,a.showWorkspace=!0},e.client.cantStartBroadcast=function(){l.errorEndBroadcast(),n(r.danger,t.cantConnect,o.warning),a.$apply()},e.client.prompterConnected=function(i){var u=_.some(d,function(e){return e.UserId===i});if(!u){var l=_.find(c,function(e){return e.UserId===i});l&&(l.Resolution=0,l.isMirroredX=!1,l.isMirroredY=!1,d.push(l),s=100*d.length/c.length,$(".progress-bar").css("width",s+"%").attr("aria-valuenow",s),d.length===c.length&&(e.server.operatorConnected(),a.connecting=!1,a.showPlayer=!0,n(r.success,t.connectSucces,o.ok)),a.$apply())}},e.client.prompterDisconnected=function(e){var i=_.find(d,function(t){return t.UserId===e});i&&(n(r.danger,t.lostConnectionWith+i.Login,o.warning),d=_.without(d,i),0===d.length&&(n(r.danger,t.allDisconnected,o.warning),a.connecting=!1,a.showPlayer=!1,a.showWorkspace=!0),a.$apply())},l}}]),app.service("canPlay",["prompterStatus",function(e){return function(t){return function(n){return t.selectedScript&&n.PrompterStatus===e.On}}}]),app.service("scriptClass",["entityState","listGroupItem",function(e,t){return function(n){return function(r){return r===n.selectedScript?t.info:r.EntityState===e.Modified?t.warning:r.EntityState===e.Added?t.success:t.empty}}}]),app.service("scriptOrder",function(){return function(e){return e.Title}}),app.factory("scriptRepository",["$http","$q","webApi",function(e,t,n){var r={};return r.get=function(){var r=t.defer();return e.get(n.script).success(function(e){r.resolve(e)}).error(function(e){r.reject(e)}),r.promise},r.post=function(r){var o=t.defer();return e.post(n.script,r).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},r}]),app.service("scriptService",["fileUpload","webApi","scriptRepository","entityState","constants","notify","notifyType","icons","prompterStatus",function(e,t,n,r,o,i,a,c,d){return function(u){var l={},p=function(e){if(!_.isString(e))return null;var t=s.words(e,"."),n=t.length;return 0===n?null:t[n-1]},f=function(){u.showImportLoader=!1,i(a.danger,o.unimported,c.warning)},g=function(e){u.scripts.push(e),u.showImportLoader=!1,i(a.success,o.imported+e.Title,c.ok)},m=function(n){e(n,t.presentation,g,f)},v=function(e,t){return{Title:e,Description:t,Sections:[],Options:{FontSize:o.defaultFontSize,ReadingSpeed:o.defaultReadingSpeed,AnnouncerName:o.defaultAnnouncer,EntityState:r.Added},EntityState:r.Added}},h=function(e,t){return{Order:e,Text:t,EntityState:r.Added}},S=function(e){return new RegExp("(|[a-zA-Z0-9])"+e+"(?=$|[^a-zA-Z0-9])")},y=function(e){var t=new FileReader;t.onload=function(){var e=s.trim(t.result);if(!e)return void f();var n=e.split(S(o.tagSection));if(0===n.length)return void f();var r=s.trim(n[0]);if(!r)return void f();var i,a=o.emptyString;if(s.include(r,o.tagDescription)){var c=r.split(S(o.tagDescription));i=s.trim(c[0]),a=s.trim(c[1])}else i=r;if(!s.startsWith(i,o.tagScript))return void f();i=i.substring(o.tagScript.length);for(var d=v(i,a),u=0,l=1;l<n.length;l++){var p=s.trim(n[l]);if(p){var m=h(u,p);d.Sections.push(m),++u}}g(d)},t.readAsText(e)},w=function(){u.showImportLoader=!1,i(a.danger,o.invalidFormat,c.warning)};return l.add=function(e){e.$valid&&(u.selectedScript=v(u.newScriptName,u.newScriptDescription),u.scripts.push(u.selectedScript),u.newScriptName=o.scriptDefaultName,u.newScriptDescription=o.emptyString,u.showScriptModal=!1)},l.remove=function(e){e===u.selectedScript&&(u.selectedScript=null),e.EntityState===r.Added?u.scripts=_.without(u.scripts,e):(e.EntityState=r.Deleted,e.Sections&&_.each(e.Sections,function(e){e.EntityState=r.Deleted}),e.Options&&(e.Options.EntityState=r.Deleted))},l.select=function(e){u.selectedScript=e},l.save=function(){var e=_.filter(u.scripts,function(e){return e.EntityState!==r.Unchanged}),t=(function(e){_.each(e,function(e){_.each(e.Sections,function(e,t){e.Order=t})})}(e),u.scripts);u.scripts=void 0,n.post(e).then(function(e){u.scripts=e,u.selectedScript=null,i(a.success,o.changesSaved,c.ok)},function(){i(a.danger,o.cnagesUnsaved,c.warning),u.scripts=t})},l["import"]=function(){u.showImport=!1,u.showImportLoader=!0;var e=u.scriptFile,t=p(e.name);"pptx"===t?m(e):"txt"===t?y(e):w()},l.initScript=function(e){u.index=_.indexOf(_.sortBy(u.scripts,"Title"),e)},l.saveToTxt=function(){var e=u.selectedScript.Title+".txt",t=o.tagScript+"\n"+u.selectedScript.Title;u.selectedScript.Description&&(t+="\n"+o.tagDescription+"\n"+u.selectedScript.Description),_.each(u.selectedScript.Sections,function(e){t+="\n\n\n"+o.tagSection+"\n"+e.Text}),saveTextAs(t,e)},l.check=function(e){e.checked?(e.checked=!1,u.checked=_.without(u.checked,e)):e.PrompterStatus===d.On&&(e.checked=!0,u.checked.push(e))},l.canCheck=function(e){return e.PrompterStatus===d.On},l}}]),app.service("manageSections",["entityState",function(e){var t=this,n=function(t){t.EntityState!==e.Added&&(t.EntityState=e.Modified)},r=function(t,n){return{Order:t,Text:"",ScriptId:n||0,EntityState:e.Added}};return t.initNewSection=function(e){e.length=0,e.push(r(0))},t.deleteSection=function(t,r){if(t.EntityState!==e.Added)t.EntityState=e.Deleted;else{var o=r.Sections.indexOf(t);r.Sections.splice(o,1)}n(r)},t.isDeleted=function(t){return t.EntityState!==e.Deleted?!0:!1},t.updateSectionState=function(t,r){null!==r&&void 0!==r&&(t.EntityState!==e.Modified&&t.EntityState!==e.Added&&(t.EntityState=e.Modified),n(r))},t.moveSection=function(t,r){r.Sections.splice(r.Sections.indexOf(t),1),n(r),_.each(r.Sections,function(t){t.EntityState!==e.Added&&t.EntityState!==e.Deleted&&(t.EntityState=e.Modified)})},t.dragNewSection=function(t,r){_.each(r.Sections,function(t){t.ScriptId=r.ScriptId,t.isFocused=!0,t.EntityState!==e.Deleted&&t.EntityState!==e.Added&&(t.EntityState=e.Modified)}),n(r)},t.addNewSection=function(e){var t=r(e.length-1,e.ScriptId);e.Sections.push(t),n(e),t.isFocused=!0},t}]),app.service("sectionServices",["constants",function(e){var t=this;return t.displaySectionIntro=function(t){var n=t.Text,r=e.sectionsIntroLength;return t.Text.length>r&&(n=t.Text.substring(0,r)+"..."),n},t}]);